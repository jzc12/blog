import{_ as g,i as v,o,c as r,j as h,b as t,k as m,v as _,l as M,m as b,t as c,F as x,d as L,p as C,q as T,s as k,r as p,f,u as w,g as I,x as $,h as F}from"./index-be06b836.js";const H={name:"MessageForm",data(){return{message:{username:"",content:"",private_message:!1},dailyLimit:20,todayCount:0,isLoadingCount:!1}},computed:{remainingMessages(){return Math.max(0,this.dailyLimit-this.todayCount)},isLimitReached(){return this.remainingMessages<=0}},methods:{async fetchTodayCount(){this.isLoadingCount=!0,this.todayCount=await v(),this.isLoadingCount=!1},async submitMessage(){this.isLimitReached||!this.message.content.trim()||(this.$emit("message-submitted",{...this.message}),this.message.content="",this.message.private_message=!1,this.$nextTick(()=>{this.$refs.contentInput.style.height="auto"}),await this.fetchTodayCount())},handleEnter(s){s.shiftKey||this.submitMessage()},adjustTextareaHeight(){const s=this.$refs.contentInput;s.style.height="auto",s.style.height=s.scrollHeight+"px"}},mounted(){this.$refs.contentInput.addEventListener("input",this.adjustTextareaHeight),this.fetchTodayCount()},beforeUnmount(){this.$refs.contentInput.removeEventListener("input",this.adjustTextareaHeight)}},B={class:"message-form"},D={key:0,class:"limit-warning"},E={class:"form-header"},V={class:"private-toggle"},j={class:"input-group"},N={class:"message-info"};function S(s,e,d,u,n,i){return o(),r("div",B,[i.isLimitReached?(o(),r("div",D," 今日留言已达上限（20条），请明天再来留言 ")):(o(),r("form",{key:1,onSubmit:e[4]||(e[4]=h((...a)=>i.submitMessage&&i.submitMessage(...a),["prevent"])),class:"form-container"},[t("div",E,[m(t("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=a=>n.message.username=a),required:"",placeholder:"昵称",class:"name-input"},null,512),[[_,n.message.username]]),t("label",V,[m(t("input",{type:"checkbox","onUpdate:modelValue":e[1]||(e[1]=a=>n.message.private_message=a)},null,512),[[M,n.message.private_message]]),e[5]||(e[5]=t("span",{class:"toggle-label"},"私信",-1))])]),t("div",j,[m(t("textarea",{"onUpdate:modelValue":e[2]||(e[2]=a=>n.message.content=a),required:"",rows:"1",placeholder:"输入留言内容...",class:"content-input",onKeydown:e[3]||(e[3]=b(h((...a)=>i.handleEnter&&i.handleEnter(...a),["prevent"]),["enter"])),ref:"contentInput"},null,544),[[_,n.message.content]]),e[6]||(e[6]=t("button",{type:"submit",class:"submit-btn",title:"发送"}," 发送 ",-1))]),t("div",N,c(n.isLoadingCount?"加载中...":`今日剩余留言次数：${i.remainingMessages}`),1)],32))])}const U=g(H,[["render",S],["__scopeId","data-v-8370e3dc"]]);const q={name:"MessageList",props:{messages:{type:Array,default:()=>[]}},methods:{formatDate(s){return s?new Date(s).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):""},scrollToBottom(){this.$nextTick(()=>{const s=this.$refs.messagesContainer;s&&(s.scrollTop=s.scrollHeight)})}},watch:{messages:{handler(){this.scrollToBottom()},deep:!0}},mounted(){this.scrollToBottom()}},K={class:"message-list"},R={key:0,class:"no-messages"},z={key:1,class:"messages-container",ref:"messagesContainer"},A={class:"message-content"},G={class:"message-header"},J={class:"user-name"},O={class:"message-date"},P={class:"message-text"};function Q(s,e,d,u,n,i){return o(),r("div",K,[d.messages.length===0?(o(),r("div",R," 还没有留言，来做第一个留言的人吧！ ")):(o(),r("div",z,[(o(!0),r(x,null,L(d.messages,(a,l)=>(o(),r("div",{key:l,class:"message-item"},[t("div",A,[t("div",G,[t("span",J,c(a.username),1),t("span",O,c(i.formatDate(a.created_at)),1)]),t("div",P,c(a.content),1)])]))),128))],512))])}const W=g(q,[["render",Q],["__scopeId","data-v-b762d3dc"]]);const X={name:"Message",components:{MessageForm:U,MessageList:W},data(){return{messages:[],isInputHidden:!1,isLoading:!1}},methods:{async addMessage(s){try{await C(s)?(await this.loadMessages(),this.$refs.messageForm&&await this.$refs.messageForm.fetchTodayCount()):alert("发送消息失败，请稍后重试")}catch(e){console.error("发送消息失败：",e),alert("发送消息失败，请稍后重试")}},async loadMessages(){if(!this.isLoading){this.isLoading=!0;try{const s=await T();this.messages=s,this.$refs.messageForm&&await this.$refs.messageForm.fetchTodayCount()}catch(s){console.error("加载消息失败：",s),alert("加载消息失败，请稍后重试")}finally{this.isLoading=!1}}},toggleInput(){this.isInputHidden=!this.isInputHidden}},created(){this.loadMessages()},computed:{iconMap(){return k}}},Y={class:"message-page"},Z={class:"message-container"},ee={class:"controls"},se={class:"control-group"},te=["disabled"];function ae(s,e,d,u,n,i){const a=p("MessageList"),l=p("MessageForm");return o(),r("div",Y,[t("div",Z,[t("div",ee,[e[1]||(e[1]=t("div",{class:"text"},[t("p",null,"欢迎留言！私信不会显示，但是我会收到")],-1)),t("div",se,[t("button",{class:"refresh-btn",onClick:e[0]||(e[0]=(...y)=>i.loadMessages&&i.loadMessages(...y)),disabled:n.isLoading,title:"刷新留言"},[(o(),f(w(n.isLoading?i.iconMap.loading:i.iconMap.refresh),{class:"icon"}))],8,te)])]),I(a,{messages:n.messages},null,8,["messages"]),t("div",{class:$(["input-area",{hidden:n.isInputHidden}])},[n.isInputHidden?F("",!0):(o(),f(l,{key:0,ref:"messageForm",onMessageSubmitted:i.addMessage},null,8,["onMessageSubmitted"]))],2)])])}const ie=g(X,[["render",ae],["__scopeId","data-v-b88f4312"]]);export{ie as default};
