import{_ as p,h as M,q as w,o as i,c as r,s as f,b as n,f as u,k as h,u as m,v as y,l as d,x,t as l,y as C,F as L,d as I,z as k,A as T,r as v,j as F,B as H}from"./index-ef375bb1.js";const B={name:"MessageForm",data(){return{showInputs:!0,message:{username:"",content:"",private_message:!1},dailyLimit:20,todayCount:0,isLoadingCount:!1}},computed:{remainingMessages(){return Math.max(0,this.dailyLimit-this.todayCount)},isLimitReached(){return this.remainingMessages<=0},iconMap(){return M}},methods:{async fetchTodayCount(){this.isLoadingCount=!0,this.todayCount=await w(),this.isLoadingCount=!1},async submitMessage(){this.isLimitReached||!this.message.content.trim()||(this.$emit("message-submitted",{...this.message}),this.message.content="",this.message.private_message=!1,this.$nextTick(()=>{this.$refs.contentInput.style.height="auto"}),await this.fetchTodayCount())},handleEnter(s){s.shiftKey||this.submitMessage()},adjustTextareaHeight(){const s=this.$refs.contentInput;s.style.height="auto",s.style.height=s.scrollHeight+"px"}},mounted(){this.$refs.contentInput.addEventListener("input",this.adjustTextareaHeight),this.fetchTodayCount()},watch:{showInputs(s){this.$nextTick(()=>{const e=this.$refs.contentInput;s&&e?e.addEventListener("input",this.adjustTextareaHeight):e&&e.removeEventListener("input",this.adjustTextareaHeight)})}}},D={class:"message-form"},E={key:0,class:"limit-warning"},$={class:"form-header"},V={key:1,type:"button",class:"toggle-input-btn",title:"随机"},j={key:2,class:"private-toggle"},q={class:"message-info"},N={key:0,class:"input-group"};function S(s,e,c,_,t,a){return i(),r("div",D,[a.isLimitReached?(i(),r("div",E," 今日留言已达上限（20条），请明天再来留言 ")):(i(),r("form",{key:1,onSubmit:e[5]||(e[5]=f((...o)=>a.submitMessage&&a.submitMessage(...o),["prevent"])),class:"form-container"},[n("div",$,[n("button",{type:"button",class:"toggle-input-btn",onClick:e[0]||(e[0]=o=>t.showInputs=!t.showInputs)},[(i(),u(h(t.showInputs?a.iconMap.squareChevronDown:a.iconMap.squareChevronUp)))]),t.showInputs?m((i(),r("input",{key:0,type:"text","onUpdate:modelValue":e[1]||(e[1]=o=>t.message.username=o),required:"",placeholder:"昵称",class:"name-input"},null,512)),[[y,t.message.username]]):d("",!0),t.showInputs?(i(),r("button",V,[(i(),u(h(a.iconMap.shuffle)))])):d("",!0),t.showInputs?(i(),r("label",j,[m(n("input",{type:"checkbox","onUpdate:modelValue":e[2]||(e[2]=o=>t.message.private_message=o)},null,512),[[x,t.message.private_message]]),e[6]||(e[6]=n("span",{class:"toggle-label"},"私信",-1))])):d("",!0),n("div",q,l(t.isLoadingCount?"加载中...":`今日剩余留言次数：${a.remainingMessages}`),1)]),t.showInputs?(i(),r("div",N,[m(n("textarea",{"onUpdate:modelValue":e[3]||(e[3]=o=>t.message.content=o),required:"",rows:"1",placeholder:"输入留言内容...",class:"content-input",onKeydown:e[4]||(e[4]=C(f((...o)=>a.handleEnter&&a.handleEnter(...o),["prevent"]),["enter"])),ref:"contentInput"},null,544),[[y,t.message.content]]),e[7]||(e[7]=n("button",{type:"submit",class:"submit-btn",title:"发送"}," 发送 ",-1))])):d("",!0)],32))])}const U=p(B,[["render",S],["__scopeId","data-v-c7143c10"]]);const z={name:"MessageList",props:{messages:{type:Array,default:()=>[]}},methods:{formatDate(s){return s?new Date(s).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):""},scrollToBottom(){this.$nextTick(()=>{const s=this.$refs.messagesContainer;s&&(s.scrollTop=s.scrollHeight)})}},watch:{messages:{handler(){this.scrollToBottom()},deep:!0}},mounted(){this.scrollToBottom()}},A={class:"message-list"},K={key:0,class:"no-messages"},R={key:1,class:"messages-container",ref:"messagesContainer"},G={class:"message-content"},J={class:"message-header"},O={class:"user-name"},P={class:"message-date"},Q={class:"message-text"};function W(s,e,c,_,t,a){return i(),r("div",A,[c.messages.length===0?(i(),r("div",K," 还没有留言，来做第一个留言的人吧！ ")):(i(),r("div",R,[(i(!0),r(L,null,I(c.messages,(o,g)=>(i(),r("div",{key:g,class:"message-item"},[n("div",G,[n("div",J,[n("span",O,l(o.username),1),n("span",P,l(a.formatDate(o.created_at)),1)]),n("div",Q,l(o.content),1)])]))),128))],512))])}const X=p(z,[["render",W],["__scopeId","data-v-b762d3dc"]]);const Y={name:"Message",components:{MessageForm:U,MessageList:X},data(){return{messages:[],isInputHidden:!1,isLoading:!1}},methods:{async addMessage(s){try{await k(s)?(await this.loadMessages(),this.$refs.messageForm&&await this.$refs.messageForm.fetchTodayCount()):alert("发送消息失败，请稍后重试")}catch(e){console.error("发送消息失败：",e),alert("发送消息失败，请稍后重试")}},async loadMessages(){if(!this.isLoading){this.isLoading=!0;try{const s=await T();this.messages=s,this.$refs.messageForm&&await this.$refs.messageForm.fetchTodayCount()}catch(s){console.error("加载消息失败：",s),alert("加载消息失败，请稍后重试")}finally{this.isLoading=!1}}},toggleInput(){this.isInputHidden=!this.isInputHidden}},created(){this.loadMessages()},computed:{iconMap(){return M}}},Z={class:"message-page"},ee={class:"message-container"},se={class:"controls"},te={class:"control-group"},ne=["disabled"];function ae(s,e,c,_,t,a){const o=v("MessageList"),g=v("MessageForm");return i(),r("div",Z,[n("div",ee,[n("div",se,[e[1]||(e[1]=n("div",{class:"text"},[n("p",null,"欢迎留言！私信不会显示，但是我会收到")],-1)),n("div",te,[n("button",{class:"refresh-btn",onClick:e[0]||(e[0]=(...b)=>a.loadMessages&&a.loadMessages(...b)),disabled:t.isLoading,title:"刷新留言"},[(i(),u(h(t.isLoading?a.iconMap.loading:a.iconMap.refresh),{class:"icon"}))],8,ne)])]),F(o,{messages:t.messages},null,8,["messages"]),n("div",{class:H(["input-area",{hidden:t.isInputHidden}])},[t.isInputHidden?d("",!0):(i(),u(g,{key:0,ref:"messageForm",onMessageSubmitted:a.addMessage},null,8,["onMessageSubmitted"]))],2)])])}const oe=p(Y,[["render",ae],["__scopeId","data-v-cd8f6363"]]);export{oe as default};
