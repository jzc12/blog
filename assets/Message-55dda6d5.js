import{_ as h,i as v,k as x,o,c as r,l as _,b as n,f as g,h as M,m,v as f,j as c,p as w,q as C,t as l,F as L,d as I,s as k,u as T,r as y,g as F,x as H}from"./index-191c08c4.js";const $={name:"MessageForm",data(){return{showInputs:!0,message:{username:"",content:"",private_message:!1},dailyLimit:20,todayCount:0,isLoadingCount:!1}},computed:{remainingMessages(){return Math.max(0,this.dailyLimit-this.todayCount)},isLimitReached(){return this.remainingMessages<=0},iconMap(){return v}},methods:{async fetchTodayCount(){this.isLoadingCount=!0,this.todayCount=await x(),this.isLoadingCount=!1},async submitMessage(){this.isLimitReached||!this.message.content.trim()||(this.$emit("message-submitted",{...this.message}),this.message.content="",this.message.private_message=!1,this.$nextTick(()=>{this.$refs.contentInput.style.height="auto"}),await this.fetchTodayCount())},handleEnter(s){s.shiftKey||this.submitMessage()},adjustTextareaHeight(){const s=this.$refs.contentInput;s.style.height="auto",s.style.height=s.scrollHeight+"px"}},mounted(){this.$refs.contentInput.addEventListener("input",this.adjustTextareaHeight),this.fetchTodayCount()},watch:{showInputs(s){this.$nextTick(()=>{const e=this.$refs.contentInput;s&&e?e.addEventListener("input",this.adjustTextareaHeight):e&&e.removeEventListener("input",this.adjustTextareaHeight)})}}},B={class:"message-form"},D={key:0,class:"limit-warning"},E={class:"form-header"},V={key:1,class:"private-toggle"},j={key:0,class:"input-group"},q={class:"message-info"};function N(s,e,d,p,t,a){return o(),r("div",B,[a.isLimitReached?(o(),r("div",D," 今日留言已达上限（20条），请明天再来留言 ")):(o(),r("form",{key:1,onSubmit:e[5]||(e[5]=_((...i)=>a.submitMessage&&a.submitMessage(...i),["prevent"])),class:"form-container"},[n("div",E,[n("button",{type:"button",class:"toggle-input-btn",onClick:e[0]||(e[0]=i=>t.showInputs=!t.showInputs)},[(o(),g(M(t.showInputs?a.iconMap.squareChevronDown:a.iconMap.squareChevronUp),{class:"icon"}))]),t.showInputs?m((o(),r("input",{key:0,type:"text","onUpdate:modelValue":e[1]||(e[1]=i=>t.message.username=i),required:"",placeholder:"昵称",class:"name-input"},null,512)),[[f,t.message.username]]):c("",!0),t.showInputs?(o(),r("label",V,[m(n("input",{type:"checkbox","onUpdate:modelValue":e[2]||(e[2]=i=>t.message.private_message=i)},null,512),[[w,t.message.private_message]]),e[6]||(e[6]=n("span",{class:"toggle-label"},"私信",-1))])):c("",!0)]),t.showInputs?(o(),r("div",j,[m(n("textarea",{"onUpdate:modelValue":e[3]||(e[3]=i=>t.message.content=i),required:"",rows:"1",placeholder:"输入留言内容...",class:"content-input",onKeydown:e[4]||(e[4]=C(_((...i)=>a.handleEnter&&a.handleEnter(...i),["prevent"]),["enter"])),ref:"contentInput"},null,544),[[f,t.message.content]]),e[7]||(e[7]=n("button",{type:"submit",class:"submit-btn",title:"发送"}," 发送 ",-1))])):c("",!0),n("div",q,l(t.isLoadingCount?"加载中...":`今日剩余留言次数：${a.remainingMessages}`),1)],32))])}const S=h($,[["render",N],["__scopeId","data-v-df2ef76f"]]);const U={name:"MessageList",props:{messages:{type:Array,default:()=>[]}},methods:{formatDate(s){return s?new Date(s).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):""},scrollToBottom(){this.$nextTick(()=>{const s=this.$refs.messagesContainer;s&&(s.scrollTop=s.scrollHeight)})}},watch:{messages:{handler(){this.scrollToBottom()},deep:!0}},mounted(){this.scrollToBottom()}},K={class:"message-list"},R={key:0,class:"no-messages"},z={key:1,class:"messages-container",ref:"messagesContainer"},A={class:"message-content"},G={class:"message-header"},J={class:"user-name"},O={class:"message-date"},P={class:"message-text"};function Q(s,e,d,p,t,a){return o(),r("div",K,[d.messages.length===0?(o(),r("div",R," 还没有留言，来做第一个留言的人吧！ ")):(o(),r("div",z,[(o(!0),r(L,null,I(d.messages,(i,u)=>(o(),r("div",{key:u,class:"message-item"},[n("div",A,[n("div",G,[n("span",J,l(i.username),1),n("span",O,l(a.formatDate(i.created_at)),1)]),n("div",P,l(i.content),1)])]))),128))],512))])}const W=h(U,[["render",Q],["__scopeId","data-v-b762d3dc"]]);const X={name:"Message",components:{MessageForm:S,MessageList:W},data(){return{messages:[],isInputHidden:!1,isLoading:!1}},methods:{async addMessage(s){try{await k(s)?(await this.loadMessages(),this.$refs.messageForm&&await this.$refs.messageForm.fetchTodayCount()):alert("发送消息失败，请稍后重试")}catch(e){console.error("发送消息失败：",e),alert("发送消息失败，请稍后重试")}},async loadMessages(){if(!this.isLoading){this.isLoading=!0;try{const s=await T();this.messages=s,this.$refs.messageForm&&await this.$refs.messageForm.fetchTodayCount()}catch(s){console.error("加载消息失败：",s),alert("加载消息失败，请稍后重试")}finally{this.isLoading=!1}}},toggleInput(){this.isInputHidden=!this.isInputHidden}},created(){this.loadMessages()},computed:{iconMap(){return v}}},Y={class:"message-page"},Z={class:"message-container"},ee={class:"controls"},se={class:"control-group"},te=["disabled"];function ne(s,e,d,p,t,a){const i=y("MessageList"),u=y("MessageForm");return o(),r("div",Y,[n("div",Z,[n("div",ee,[e[1]||(e[1]=n("div",{class:"text"},[n("p",null,"欢迎留言！私信不会显示，但是我会收到")],-1)),n("div",se,[n("button",{class:"refresh-btn",onClick:e[0]||(e[0]=(...b)=>a.loadMessages&&a.loadMessages(...b)),disabled:t.isLoading,title:"刷新留言"},[(o(),g(M(t.isLoading?a.iconMap.loading:a.iconMap.refresh),{class:"icon"}))],8,te)])]),F(i,{messages:t.messages},null,8,["messages"]),n("div",{class:H(["input-area",{hidden:t.isInputHidden}])},[t.isInputHidden?c("",!0):(o(),g(u,{key:0,ref:"messageForm",onMessageSubmitted:a.addMessage},null,8,["onMessageSubmitted"]))],2)])])}const ie=h(X,[["render",ne],["__scopeId","data-v-b88f4312"]]);export{ie as default};
