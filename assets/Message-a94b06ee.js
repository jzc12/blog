import{_ as u,i as y,o,c as r,j as _,b as t,k as m,v as p,l as v,m as M,t as d,F as b,d as L,p as x,q as C,r as f,g as I,s as k,f as T,h as w}from"./index-88968033.js";const $={name:"MessageForm",data(){return{message:{username:"",content:"",private_message:!1},dailyLimit:20,todayCount:0,isLoadingCount:!1}},computed:{remainingMessages(){return Math.max(0,this.dailyLimit-this.todayCount)},isLimitReached(){return this.remainingMessages<=0}},methods:{async fetchTodayCount(){this.isLoadingCount=!0,this.todayCount=await y(),this.isLoadingCount=!1},async submitMessage(){this.isLimitReached||!this.message.content.trim()||(this.$emit("message-submitted",{...this.message}),this.message.content="",this.message.private_message=!1,this.$nextTick(()=>{this.$refs.contentInput.style.height="auto"}),await this.fetchTodayCount())},handleEnter(s){s.shiftKey||this.submitMessage()},adjustTextareaHeight(){const s=this.$refs.contentInput;s.style.height="auto",s.style.height=s.scrollHeight+"px"}},mounted(){this.$refs.contentInput.addEventListener("input",this.adjustTextareaHeight),this.fetchTodayCount()},beforeUnmount(){this.$refs.contentInput.removeEventListener("input",this.adjustTextareaHeight)}},F={class:"message-form"},H={key:0,class:"limit-warning"},B={class:"form-header"},E={class:"private-toggle"},V={class:"input-group"},D={class:"message-info"};function j(s,e,l,h,a,i){return o(),r("div",F,[i.isLimitReached?(o(),r("div",H," 今日留言已达上限（20条），请明天再来留言 ")):(o(),r("form",{key:1,onSubmit:e[4]||(e[4]=_((...n)=>i.submitMessage&&i.submitMessage(...n),["prevent"])),class:"form-container"},[t("div",B,[m(t("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=n=>a.message.username=n),required:"",placeholder:"昵称",class:"name-input"},null,512),[[p,a.message.username]]),t("label",E,[m(t("input",{type:"checkbox","onUpdate:modelValue":e[1]||(e[1]=n=>a.message.private_message=n)},null,512),[[v,a.message.private_message]]),e[5]||(e[5]=t("span",{class:"toggle-label"},"私信 : 不会在主页显示，我会收到✅ ",-1))])]),t("div",V,[m(t("textarea",{"onUpdate:modelValue":e[2]||(e[2]=n=>a.message.content=n),required:"",rows:"1",placeholder:"输入留言内容...",class:"content-input",onKeydown:e[3]||(e[3]=M(_((...n)=>i.handleEnter&&i.handleEnter(...n),["prevent"]),["enter"])),ref:"contentInput"},null,544),[[p,a.message.content]]),e[6]||(e[6]=t("button",{type:"submit",class:"submit-btn",title:"发送"}," 发送 ",-1))]),t("div",D,d(a.isLoadingCount?"加载中...":`今日剩余留言次数：${i.remainingMessages}`),1)],32))])}const N=u($,[["render",j],["__scopeId","data-v-3b4d0423"]]);const S={name:"MessageList",props:{messages:{type:Array,default:()=>[]}},methods:{formatDate(s){return s?new Date(s).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):""},scrollToBottom(){this.$nextTick(()=>{const s=this.$refs.messagesContainer;s&&(s.scrollTop=s.scrollHeight)})}},watch:{messages:{handler(){this.scrollToBottom()},deep:!0}},mounted(){this.scrollToBottom()}},U={class:"message-list"},q={key:0,class:"no-messages"},K={key:1,class:"messages-container",ref:"messagesContainer"},R={class:"message-content"},z={class:"message-header"},A={class:"user-name"},G={class:"message-date"},J={class:"message-text"};function O(s,e,l,h,a,i){return o(),r("div",U,[l.messages.length===0?(o(),r("div",q," 还没有留言，来做第一个留言的人吧！ ")):(o(),r("div",K,[(o(!0),r(b,null,L(l.messages,(n,c)=>(o(),r("div",{key:c,class:"message-item"},[t("div",R,[t("div",z,[t("span",A,d(n.username),1),t("span",G,d(i.formatDate(n.created_at)),1)]),t("div",J,d(n.content),1)])]))),128))],512))])}const P=u(S,[["render",O],["__scopeId","data-v-b762d3dc"]]);const Q={name:"Message",components:{MessageForm:N,MessageList:P},data(){return{messages:[],isInputHidden:!1,isLoading:!1}},methods:{async addMessage(s){try{await x(s)?(await this.loadMessages(),this.$refs.messageForm&&await this.$refs.messageForm.fetchTodayCount()):alert("发送消息失败，请稍后重试")}catch(e){console.error("发送消息失败：",e),alert("发送消息失败，请稍后重试")}},async loadMessages(){if(!this.isLoading){this.isLoading=!0;try{const s=await C();this.messages=s,this.$refs.messageForm&&await this.$refs.messageForm.fetchTodayCount()}catch(s){console.error("加载消息失败：",s),alert("加载消息失败，请稍后重试")}finally{this.isLoading=!1}}},toggleInput(){this.isInputHidden=!this.isInputHidden}},created(){this.loadMessages()}},W={class:"message-page"},X={class:"message-container"},Y={class:"controls"},Z={class:"control-group"},ee=["disabled"],se=["title"];function te(s,e,l,h,a,i){const n=f("MessageList"),c=f("MessageForm");return o(),r("div",W,[t("div",X,[t("div",Y,[t("div",Z,[t("button",{class:"refresh-btn",onClick:e[0]||(e[0]=(...g)=>i.loadMessages&&i.loadMessages(...g)),disabled:a.isLoading,title:"刷新留言"},d(a.isLoading?"加载中...":"刷新留言"),9,ee)])]),I(n,{messages:a.messages},null,8,["messages"]),t("div",{class:k(["input-area",{hidden:a.isInputHidden}])},[a.isInputHidden?w("",!0):(o(),T(c,{key:0,ref:"messageForm",onMessageSubmitted:i.addMessage},null,8,["onMessageSubmitted"]))],2),t("button",{class:"toggle-input-btn",onClick:e[1]||(e[1]=(...g)=>i.toggleInput&&i.toggleInput(...g)),title:a.isInputHidden?"显示输入框":"隐藏输入框"},d(a.isInputHidden?"v":"^"),9,se)])])}const ne=u(Q,[["render",te],["__scopeId","data-v-d0dd2256"]]);export{ne as default};
